<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>IFR Flight Performance Sheet</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0a3d62">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="IFR Sheet">
<style>
  :root { --fg:#0a0a0a; --muted:#555; --line:#d9d9d9; --accent:#0a3d62; --bg:#fff; --field:#f8f8f8; }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--fg);background:var(--bg);margin:0;padding:24px}
  header{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:12px;margin-bottom:8px}
  h1{text-align:center;font-weight:700;font-size:16px;letter-spacing:.08em;margin:0}
  .hdr-fields{display:flex;gap:16px;justify-content:space-between;align-items:center}
  label{font-size:12px;color:var(--muted)}
  input,select,textarea{font:inherit;font-size:13px;padding:6px 8px;border:1px solid var(--line);border-radius:6px;background:var(--field);width:100%}
  input[type=number]{text-align:right}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{border:1px solid var(--line);border-radius:10px;padding:12px}
  .card h2{font-size:12px;font-weight:700;letter-spacing:.06em;color:var(--accent);margin:0 0 8px 0}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--line);padding:6px 8px;font-size:12px}
  th{background:#f1f3f5;text-align:center;font-weight:600}
  td input{border:none;background:transparent;padding:0;width:100%}
  .thin{padding:2px 6px}
  .grid-3{display:grid;grid-template-columns:auto 1fr 1fr 1fr;gap:6px;align-items:center}
  .grid-3>div:first-child{font-size:12px;color:var(--muted);text-align:right;padding-right:6px}
  .section{display:grid;gap:10px}
  .cols-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .cols-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .cols-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .muted{color:var(--muted);font-size:12px}
  .route{display:grid;gap:8px}
  .route textarea{min-height:50px;resize:vertical;line-height:1.35}
  .toolbar{display:flex;gap:8px;justify-content:flex-end;margin:10px 0 16px;flex-wrap:wrap}
  button{appearance:none;border:1px solid var(--line);background:#fafafa;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:13px}
  button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}

  /* ------- LEGACY PDF LAYOUT FOR PRINT ------- */
  /* Switch with body.legacy-print (also applied during @media print) */
  body.legacy-print, @media print {
    padding: 0.5in;
    background: #fff;
  }
  body.legacy-print .toolbar, @media print {.toolbar{display:none}}
  body.legacy-print input, body.legacy-print textarea, @media print { input,textarea{border-color:#bfbfbf; background:transparent} }
  body.legacy-print .card, @media print { .card{page-break-inside:avoid;border-color:#bfbfbf;border-radius:4px} }
  body.legacy-print h1{font-size:14px;letter-spacing:.06em}

  /* Reflow for one-page PDF: tighter top grids, dotted leader fields, wider route area */
  body.legacy-print .row.top { grid-template-columns: 1.1fr 0.9fr; gap: 12px; }
  body.legacy-print .row.bottom { grid-template-columns: 1fr 1fr; gap: 12px; }
  /* Dotted leaders for performance lines */
  .leader input { border: none; border-bottom: 1px dotted #888; border-radius:0; padding: 2px 0; background: transparent; }
  .leader label { color:#000; }

  /* Tighter spacing in legacy mode */
  body.legacy-print .card h2 { margin-bottom: 4px; }
  body.legacy-print th, body.legacy-print td { padding: 4px 6px; font-size: 11px; }
  body.legacy-print label { font-size: 11px; }

</style>
</head>
<body>
  <header>
    <div class="hdr-fields cols-2">
      <div><label>Aircraft</label><input id="aircraft" /></div>
      <div><label>Registration</label><input id="reg" /></div>
    </div>
    <h1>IFR FLIGHT PERFORMANCE SHEET</h1>
    <div class="hdr-fields cols-3">
      <div><label>Dep (ICAO)</label><input id="dep" maxlength="4" /></div>
      <div><label>Arr (ICAO)</label><input id="arr" maxlength="4" /></div>
      <div><label>Alt (ICAO)</label><input id="alt" maxlength="4" /></div>
    </div>
  </header>

  <div class="toolbar">
    <button onclick="saveData()">Save</button>
    <button onclick="loadData()">Load</button>
    <button onclick="clearData()">Clear</button>
    <button onclick="window.print()">Print (Browser)</button>
    <button class="primary" onclick="printLegacy()">Print (Airline PDF Layout)</button>
    <button onclick="installPrompt()">Add to Home Screen</button>
  </div>

  <!-- TOP HALF -->
  <div class="row top">
    <section class="card section" id="wb">
      <h2>WEIGHT &amp; BALANCE</h2>
      <table>
        <thead><tr><th>Item</th><th>Weight</th><th>Arm</th><th>Moment</th></tr></thead>
        <tbody>
          <tr><td>B.E.W</td><td><input type="number" step="0.1" class="w" /></td><td><input type="number" step="0.001" class="a" /></td><td class="thin"><input type="number" step="0.01" class="m" /></td></tr>
          <tr><td>PILOTS</td><td><input type="number" step="0.1" class="w" /></td><td><input type="number" step="0.001" class="a" /></td><td class="thin"><input type="number" step="0.01" class="m" /></td></tr>
          <tr><td>REAR PAX</td><td><input type="number" step="0.1" class="w" /></td><td><input type="number" step="0.001" class="a" /></td><td class="thin"><input type="number" step="0.01" class="m" /></td></tr>
          <tr><td>AFT CARGO</td><td><input type="number" step="0.1" class="w" /></td><td><input type="number" step="0.001" class="a" /></td><td class="thin"><input type="number" step="0.01" class="m" /></td></tr>
          <tr><td>ZFW</td><td><input type="number" step="0.1" class="w" /></td><td><input type="number" step="0.001" class="a" /></td><td class="thin"><input type="number" step="0.01" class="m" /></td></tr>
          <tr><td>FUEL</td><td><input type="number" step="0.1" class="w" /></td><td><input type="number" step="0.001" class="a" /></td><td class="thin"><input type="number" step="0.01" class="m" /></td></tr>
          <tr><td>T/O</td><td><input type="number" step="0.1" class="w" /></td><td><input type="number" step="0.001" class="a" /></td><td class="thin"><input type="number" step="0.01" class="m" /></td></tr>
          <tr><td>Used</td><td><input type="number" step="0.1" class="w" /></td><td><input type="number" step="0.001" class="a" /></td><td class="thin"><input type="number" step="0.01" class="m" /></td></tr>
          <tr><td>LDG</td><td><input type="number" step="0.1" class="w" /></td><td><input type="number" step="0.001" class="a" /></td><td class="thin"><input type="number" step="0.01" class="m" /></td></tr>
        </tbody>
      </table>
      <div class="muted">Any two of Weight, Arm, Moment will auto-solve the third (Moment = Weight × Arm).</div>
    </section>

    <section class="card section" id="ap">
      <h2>AIRPORT PERFORMANCE</h2>
      <div class="grid-3"><div>&nbsp;</div><strong>Dep:</strong><strong>Arr:</strong><strong>Alt:</strong></div>
      <div class="grid-3"><div>RWY</div><input id="rw_dep"><input id="rw_arr"><input id="rw_alt"></div>
      <div class="grid-3"><div>Length</div><input id="len_dep"><input id="len_arr"><input id="len_alt"></div>
      <div class="grid-3"><div>Wind</div><input id="wind_dep"><input id="wind_arr"><input id="wind_alt"></div>
      <div class="grid-3"><div>H‑Wind</div><input id="h_dep"><input id="h_arr"><input id="h_alt"></div>
      <div class="grid-3"><div>X‑Wind</div><input id="x_dep"><input id="x_arr"><input id="x_alt"></div>
      <div class="grid-3"><div>P.A.</div><input id="pa_dep"><input id="pa_arr"><input id="pa_alt"></div>
      <div class="grid-3"><div>Temp</div><input id="t_dep"><input id="t_arr"><input id="t_alt"></div>
      <div class="grid-3"><div>T/O roll</div><input id="tor_dep"><input id="tor_arr"><input id="tor_alt"></div>
      <div class="grid-3"><div>50’</div><input id="t50_dep"><input id="t50_arr"><input id="t50_alt"></div>
      <div class="grid-3"><div>LDG roll</div><input id="ldr_dep"><input id="ldr_arr"><input id="ldr_alt"></div>
      <div class="grid-3"><div>50’</div><input id="l50_dep"><input id="l50_arr"><input id="l50_alt"></div>
    </section>
  </div>

  <!-- BOTTOM HALF -->
  <div class="row bottom" style="margin-top:16px;">
    <section class="card section" id="left">
      <div class="cols-2">
        <div>
          <h2>SPEEDS</h2>
          <div class="cols-2 leader">
            <div><label>vR</label><input id="vr"></div>
            <div><label>vAPP</label><input id="vapp"></div>
          </div>
          <div>
            <label>vREF</label>
            <div class="muted">= VS0 (KCAS) × √(WT‑LDG / WT‑GROSS)</div>
            <div class="cols-3 leader" style="margin-top:6px;">
              <div><label>VS0 (KCAS)</label><input id="vs0" type="number" step="0.1"></div>
              <div><label>WT‑LDG</label><input id="wt_ldg" type="number" step="1"></div>
              <div><label>WT‑GROSS</label><input id="wt_gross" type="number" step="1"></div>
            </div>
            <div class="leader" style="margin-top:6px;"><label>vREF (calc)</label><input id="vref_calc" readonly></div>
          </div>
          <div class="cols-3 leader" style="margin-top:8px;">
            <div><label>VY</label><input id="vy"></div>
            <div><label>VX</label><input id="vx"></div>
            <div><label>VMC</label><input id="vmc"></div>
          </div>
        </div>
        <div>
          <h2>OEI CLIMB PERFORMANCE</h2>
          <div class="cols-2 leader">
            <div><label>T/O vYSE</label><input id="to_vyse"></div>
            <div><label>ROC</label><input id="to_roc"></div>
          </div>
          <div class="cols-2 leader">
            <div><label>CRZ vYSE</label><input id="crz_vyse"></div>
            <div><label>ROC</label><input id="crz_roc"></div>
          </div>
          <h2 style="margin-top:10px;">TAKEOFF SAFETY</h2>
          <div class="leader"><label>Accelerate‑Stop Distance</label><input id="asd"></div>
        </div>
      </div>
    </section>

    <section class="card section" id="right">
      <h2>CRUISE (CRZ)</h2>
      <div class="cols-3 leader">
        <div><label>%PWR</label><input id="pwr"></div>
        <div><label>MAP</label><input id="map"></div>
        <div><label>RPM</label><input id="rpm"></div>
      </div>
      <div class="cols-4 leader">
        <div><label>KTAS</label><input id="ktas"></div>
        <div><label>KIAS</label><input id="kias"></div>
        <div><label>GS</label><input id="gs"></div>
        <div><label>F.C.</label><input id="fc"></div>
      </div>

      <h2>FUEL &amp; ENDURANCE</h2>
      <div class="cols-2 leader">
        <div><label>Fuel On Board</label><input id="fob"></div>
        <div><label>Planned Burn [+APCH and Missed APCH]:</label><input id="planned_burn"></div>
      </div>
      <div class="cols-3 leader">
        <div><label>Contingency Fuel</label><input id="cont_fuel"></div>
        <div><label>Fuel to Alternate</label><input id="alt_fuel"></div>
        <div><label>Reserve Fuel</label><input id="res_fuel"></div>
      </div>
      <div class="leader"><label>Total Fuel Required</label><input id="total_fuel"></div>

      <h2>TIME</h2>
      <div class="cols-3 leader">
        <div><label>ETE</label><input id="ete"></div>
        <div><label>ETA</label><input id="eta"></div>
        <div><label>ETE (Alt)</label><input id="ete_alt"></div>
      </div>
    </section>
  </div>

  <section class="card route" style="margin-top:16px;">
    <h2>ROUTE</h2>
    <textarea id="route" placeholder="e.g., CYYZ NUBER5 NUBER OAKVL KLYNE..."></textarea>
    <h2>ROUTE (ALT)</h2>
    <textarea id="route_alt" placeholder="Alternate route / clearance"></textarea>
  </section>

<script>
// Service worker registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(console.error));
}

// Install prompt (Android/desktop). iOS: Share → Add to Home Screen
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; });
function installPrompt(){ if (deferredPrompt) deferredPrompt.prompt(); else alert('On iPhone/iPad: Share → Add to Home Screen.'); }

// W&B: any-two-solve-third per row
function solveRow(tr){
  const wEl = tr.querySelector('.w');
  const aEl = tr.querySelector('.a');
  const mEl = tr.querySelector('.m');
  const w = parseFloat(wEl.value);
  const a = parseFloat(aEl.value);
  const m = parseFloat(mEl.value);

  const hasW = !isNaN(w);
  const hasA = !isNaN(a);
  const hasM = !isNaN(m);

  if (hasW && hasA && !hasM) {
    mEl.value = (w * a).toFixed(2);
  } else if (hasW && hasM && !hasA && w !== 0) {
    aEl.value = (m / w).toFixed(3);
  } else if (hasA && hasM && !hasW && a !== 0) {
    wEl.value = (m / a).toFixed(1);
  }
}
function attachWBHandlers(){
  document.querySelectorAll('#wb tbody tr').forEach(tr=>{
    ['.w','.a','.m'].forEach(sel=>{
      const el = tr.querySelector(sel);
      if (!el) return;
      el.addEventListener('input', ()=>solveRow(tr));
    });
  });
}
attachWBHandlers();

// vREF calc
function calcVref(){
  const vs0=parseFloat(document.getElementById('vs0').value||0);
  const wt_ldg=parseFloat(document.getElementById('wt_ldg').value||0);
  const wt_gross=parseFloat(document.getElementById('wt_gross').value||0);
  let vref=''; if(vs0>0&&wt_ldg>0&&wt_gross>0){ vref=(vs0*Math.sqrt(wt_ldg/wt_gross)).toFixed(1); }
  document.getElementById('vref_calc').value=vref;
}
['vs0','wt_ldg','wt_gross'].forEach(id=>document.getElementById(id).addEventListener('input',calcVref));

// Local Storage
const LS_KEY='ifr_perf_sheet_v1';
function saveData(){const data={};document.querySelectorAll('input,textarea').forEach(el=>data[el.id]=el.value);localStorage.setItem(LS_KEY,JSON.stringify(data));alert('Saved.');}
function loadData(){const raw=localStorage.getItem(LS_KEY);if(!raw){alert('No saved data.');return;}const data=JSON.parse(raw);Object.entries(data).forEach(([k,v])=>{const el=document.getElementById(k);if(el)el.value=v;});calcVref(); attachWBHandlers();}
function clearData(){if(confirm('Clear all fields?')){document.querySelectorAll('input,textarea').forEach(el=>el.value='');localStorage.removeItem(LS_KEY);}}

// Legacy print toggle
function printLegacy(){
  document.body.classList.add('legacy-print');
  // Allow layout to settle, then invoke print
  setTimeout(()=>{
    window.print();
    // Remove class after print (some browsers fire afterprint event)
    setTimeout(()=>document.body.classList.remove('legacy-print'), 500);
  }, 100);
}
</script>
</body>
</html>
